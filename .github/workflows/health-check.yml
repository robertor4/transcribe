name: Health Check

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      redis_status:
        description: 'Redis health status'
        value: ${{ jobs.health-checks.outputs.redis }}
      api_status:
        description: 'API health status'
        value: ${{ jobs.health-checks.outputs.api }}
      web_status:
        description: 'Web health status'
        value: ${{ jobs.health-checks.outputs.web }}
      traefik_status:
        description: 'Traefik health status'
        value: ${{ jobs.health-checks.outputs.traefik }}
      site_status:
        description: 'Site accessibility status'
        value: ${{ jobs.health-checks.outputs.site }}

jobs:
  health-checks:
    name: Run health checks
    runs-on: ubuntu-latest
    outputs:
      redis: ${{ steps.redis.outcome }}
      api: ${{ steps.api.outcome }}
      web: ${{ steps.web.outcome }}
      traefik: ${{ steps.traefik.outcome }}
      site: ${{ steps.site.outcome }}

    steps:
      - name: Check Redis
        id: redis
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            if docker exec transcribe-redis redis-cli ping 2>/dev/null | grep -q "PONG"; then
              echo "âœ… Redis: Healthy"
              exit 0
            else
              echo "âŒ Redis: Not responding"
              exit 1
            fi

      - name: Check API health endpoint
        id: api
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            if docker exec transcribe-api wget --spider -q http://localhost:3001/health; then
              echo "âœ… API: Healthy"
              exit 0
            else
              echo "âŒ API: Health check failed"
              exit 1
            fi

      - name: Check Web container
        id: web
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            WEB_STATUS=$(docker inspect transcribe-web --format='{{.State.Status}}' 2>/dev/null || echo "not found")
            if [ "$WEB_STATUS" = "running" ]; then
              echo "âœ… Web: Running"
              exit 0
            else
              echo "âŒ Web: $WEB_STATUS"
              exit 1
            fi

      - name: Check Traefik
        id: traefik
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            TRAEFIK_STATUS=$(docker inspect transcribe-traefik --format='{{.State.Status}}' 2>/dev/null || echo "not found")
            if [ "$TRAEFIK_STATUS" = "running" ]; then
              echo "âœ… Traefik: Running"
              exit 0
            else
              echo "âŒ Traefik: $TRAEFIK_STATUS"
              exit 1
            fi

      - name: Verify site accessibility
        id: site
        continue-on-error: true
        run: |
          echo "ðŸŒ Checking marketing site..."
          for i in {1..5}; do
            SITE_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" https://neuralsummary.com 2>/dev/null || echo "000")
            if [ "$SITE_STATUS" = "200" ]; then
              echo "âœ… https://neuralsummary.com is accessible (HTTP $SITE_STATUS)"
              break
            fi
            echo "â³ Attempt $i/5: HTTP $SITE_STATUS, retrying..."
            sleep 5
          done
          if [ "$SITE_STATUS" != "200" ]; then
            echo "âŒ Marketing site not accessible after 5 attempts"
            exit 1
          fi

          echo "ðŸŒ Checking app site..."
          for i in {1..5}; do
            APP_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" https://app.neuralsummary.com 2>/dev/null || echo "000")
            if [ "$APP_STATUS" = "200" ] || [ "$APP_STATUS" = "302" ] || [ "$APP_STATUS" = "307" ]; then
              echo "âœ… https://app.neuralsummary.com is accessible (HTTP $APP_STATUS)"
              break
            fi
            echo "â³ Attempt $i/5: HTTP $APP_STATUS, retrying..."
            sleep 5
          done
          if [ "$APP_STATUS" != "200" ] && [ "$APP_STATUS" != "302" ] && [ "$APP_STATUS" != "307" ]; then
            echo "âŒ App site not accessible after 5 attempts"
            exit 1
          fi

      - name: Get container logs
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ“‹ Container Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep transcribe || true

            echo ""
            echo "ðŸ“‹ Recent API logs (last 20 lines):"
            docker logs --tail 20 transcribe-api 2>&1 | grep -v 'WebSocket\|Health check' || true

            echo ""
            echo "ðŸ“‹ Recent Web logs (last 10 lines):"
            docker logs --tail 10 transcribe-web 2>&1 || true

      - name: Create health summary
        if: always()
        run: |
          echo "# ðŸ¥ Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.redis.outcome }}" = "success" ]; then
            echo "| Redis | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Redis | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.api.outcome }}" = "success" ]; then
            echo "| API | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.web.outcome }}" = "success" ]; then
            echo "| Web | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Web | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.traefik.outcome }}" = "success" ]; then
            echo "| Traefik | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Traefik | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.site.outcome }}" = "success" ]; then
            echo "| Site (neuralsummary.com) | âœ… Accessible |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Site (neuralsummary.com) | âŒ Not accessible |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ steps.redis.outcome }}" = "success" ] && \
             [ "${{ steps.api.outcome }}" = "success" ] && \
             [ "${{ steps.web.outcome }}" = "success" ] && \
             [ "${{ steps.traefik.outcome }}" = "success" ] && \
             [ "${{ steps.site.outcome }}" = "success" ]; then
            echo "**Overall Status:** âœ… All systems operational" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Overall Status:** âš ï¸ Some services are not healthy" >> $GITHUB_STEP_SUMMARY
          fi
