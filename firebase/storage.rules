rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the file
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to validate audio file (for direct browser uploads)
    // Max 5GB to support enterprise tier users with long recordings
    function isValidAudioFile() {
      return request.resource.size < 5 * 1024 * 1024 * 1024 && // Max 5GB
        request.resource.contentType.matches('audio/.*|video/.*');
    }

    // Audio files storage - supports direct browser uploads
    match /audio/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidAudioFile();
      allow delete: if isOwner(userId);
    }

    // Uploads folder - for direct browser uploads before processing
    // Files here are moved to audio/ folder after validation by backend
    match /uploads/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidAudioFile();
      allow delete: if isOwner(userId);
    }
    
    // Transcription outputs
    match /transcriptions/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if false; // Only backend can write
      allow delete: if isOwner(userId);
    }

    // Chunked recording uploads (streamed during recording)
    // Structure: recordings/{userId}/{sessionId}/chunk_XXX.webm or metadata.json
    match /recordings/{userId}/{sessionId}/{fileName} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
        request.resource.size < 10 * 1024 * 1024 && // Max 10MB per chunk
        (request.resource.contentType.matches('audio/.*') ||
         request.resource.contentType == 'application/json');
      allow delete: if isOwner(userId);
    }
    
    // User profile images
    match /profiles/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) &&
        request.resource.size < 5 * 1024 * 1024 && // Max 5MB
        request.resource.contentType.matches('image/.*');
      allow delete: if isOwner(userId);
    }

    // Public blog images (AI-generated, no authentication required)
    // These are decorative images with no privacy concerns
    match /public/blog-images/{userId}/{fileName} {
      allow read: if true; // Public read access
      allow write: if false; // Only backend can write via Admin SDK
      allow delete: if false; // Only backend can delete
    }
  }
}